name: Test Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test-db-integration:
    name: Integration Tests (DB)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run health API tests
      run: |
        python -m unittest tests.integration_db.test_health_api -v
    
    - name: Run dashboard summary API tests
      run: |
        python -m unittest tests.integration_db.test_dashboard_summary_api -v
    
    - name: Run invoices API tests
      run: |
        python -m unittest tests.integration_db.test_invoices_api -v
    
    - name: Run risk anomalies API tests
      run: |
        python -m unittest tests.integration_db.test_risk_anomalies_api -v
    
    - name: Run risk vendors and recalculate API tests
      run: |
        python -m unittest tests.integration_db.test_risk_vendors_and_recalculate_api -v
    
    - name: Run sync API tests (mocked)
      run: |
        python -m unittest tests.integration_db.test_sync_run_api -v

  test-erpnext-live:
    name: Integration Tests (ERPNext Live)
    runs-on: ubuntu-latest
    # Only run if ERPNext credentials are available
    if: ${{ github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run ERPNext live sync tests
      env:
        ERPNEXT_BASE_URL: ${{ secrets.ERPNEXT_BASE_URL }}
        ERPNEXT_API_KEY: ${{ secrets.ERPNEXT_API_KEY }}
        ERPNEXT_API_SECRET: ${{ secrets.ERPNEXT_API_SECRET }}
      run: |
        python -m unittest tests.integration_erpnext_live.test_sync_run_live_api -v
      continue-on-error: true

  test-all:
    name: Run All Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run all DB integration tests
      run: |
        python -m unittest discover -s tests/integration_db -p "test_*.py" -v
    
    - name: Test summary
      if: always()
      run: echo "All DB integration tests completed"
